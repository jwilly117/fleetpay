<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Company Management 📋</title>

    <!-- Placeholder link to React / Bootstrap -->

    <!-- Link local CSS Sheet -->

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <link rel="stylesheet" href="/css/style.css">

    <style>
        /* Customize table-active class for light yellow background */
        .table-active {
            background-color: #d3b140 !important; /* Light yellow */
            --bs-table-bg-state: rgb(166, 166, 255);
        }
        body{
            /* background-color: rgb(196, 225, 255); */
        }
         /* Highlight cells in light pink */
         .highlight-pink {
            background-color: #f2c4c4 !important; /* Light pink */
        }
        /* Toast top right */
        .toast-container {
            position: fixed;
            top: 10%;
            right: 5%;
        }
        /* Custom background for the toast */
        .toast-light-blue {
            background-color: #a9eefa !important; /* Light blue */
            color: #0c5460; /* Dark text to match light blue */
            box-shadow: 0 8px 10px rgba(0, 0, 0, 0.4), 0 6px 20px rgba(0, 0, 0, 0.39); /* Drop shadow */

        }
        /* Breathing glow effect for input field */
        @keyframes breathingGlow {
            0% {
                box-shadow: 0 0 10px rgba(0, 38, 255, 0.5);
            }
            50% {
                box-shadow: 0 0 30px rgba(0, 38, 255, 0.9);
            }
            100% {
                box-shadow: 0 0 10px rgba(0, 38, 255, 0.5);
            }
        }
        .glow-input {
            animation: breathingGlow 2s infinite;
            border: 1px solid rgba(0, 38, 255, 0.5);
        }

        /* Row slide-down animation */
        @keyframes slideDown {
            0% {
                transform: translateY(-20px);
                opacity: 0;
            }
            100% {
                transform: translateY(0);
                opacity: 1;
            }
        }
        .slide-down {
            animation: slideDown 0.5s ease-out;
        }
        .non-selectable {
            background-color: #7314144c !important; /* Light pink for non-selectable rows */
            pointer-events: none; /*  Disable Selection */
        }
        /* Strobe and glow animation for "Scheduled" cells */
        @keyframes strobeGlow {
            0%, 100% {
                box-shadow: 0 0 10px rgba(255, 0, 0, 0.5), 0 0 20px rgba(255, 0, 0, 0.8);
                background-color: #ffe6e6;
            }
            50% {
                box-shadow: 0 0 20px rgba(255, 0, 0, 1), 0 0 40px rgba(255, 0, 0, 1);
                background-color: #ffcccc;
            }
        }
        .strobe-glow {
            animation: strobeGlow 2s infinite;
        }        


    </style>

<style>
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
    }
    th {
      background-color: #f2f2f2;
    }
    button {
      padding: 5px 10px;
      background-color: #e74c3c;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background-color: #c0392b;
    }
    .approve-btn {
      background-color: #1f7a45;
      color: white;
    }
    .approve-btn:hover {
      background-color: #27ae60;
    }
        /* Animation styles */
        tbody tr {
      opacity: 1;
      transform: translateY(20px);
      transition: opacity 0.5s ease, transform 0.5s ease;
    }
    tbody tr.visible {
      opacity: 1;
      transform: translateY(0);
    }
  </style>
</head>
<body>

    <!-- Main page header -->
    <div class="page-header" style="padding-top: 15px;">
        <img src="/img/fleetpay_dark.jpg" alt="" style="height: 50px;">
        <p style="font-size: 14px;">Sql Database Testing Environment</p>
    </div>

    
    <br><br>
    <!-- Toggle Button -->
    <button id="toggleSidebar" class="btn btn-secondary" style="position: fixed; top: 20px; left: 20px; z-index: 999; background-color: #0e6170;">
        <i class="fas fa-bars"></i>
    </button>
  

    <!-- Sidebar -->
    <!-- Font Awesome CDN for icons (add in <head> if not already included) -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

        <div class="sidebar" id="sidebar">

            <div class="sidebar-content">
              <br><br>

              <h3 class="section-header " style="text-align: center; text-decoration: wavy;">Main Menu</h3><br>
              <a href="Dashboard.html" style="text-align: center; background-color: #416682;"><strong>💸 My Dashboard</strong></a>
              <hr  class="section-header">


              <h6 class="section-header" style="color: lightgray; font-weight: bolder;">Requests</h6>
                <a href="CreateRequest.html">🔸Create Request</a>
                <a href="ReviewRequest.html">🔸Review Requests</a>
                <a href="ReportIssue.html">🔸Help or Report Issue</a>


              <h6 class="section-header" style="color: lightgray; font-weight: bolder;">Management</h6>
              <a href="CompaniesAdmin.html" style="background-color: #035b6a;">🔸Company Admin</a>
              <a href="UsersAdmin.html">🔸User Admin</a>
              <a href="BankLinking.html">🔸Banking Admin</a>
              

              <h6 class="section-header" style="color: lightgray; font-weight: bolder;">Financial Records</h6>
              <a href="Payrollexclude.html">🔸Payroll Exclusions</a>
              <a href="ArchiveRecords.html">🔸Payout Archives</a>
              <a href="settings.html">🔸Settings</a>
              <a href="contact.html"> 🔸More Info</a>

            </div>
          
            <!-- Moved to bottom -->
            <div class="user-panel">
              <i class="fas fa-user-circle fa-2x me-2"></i>
              
            <div class="user-info">
                <div><strong>Jake W.</strong></div>
                <div style="font-size: 0.85em;">
                    <i class="fas fa-badge-check" style="color: limegreen;"></i> Verified
                  </div>
                </div>

            <div class="user-actions">
                <i class="fas fa-cog mx-2" title="Settings"></i>
                <i class="fas fa-sign-out-alt" title="Logout" onclick="logoutUser()" style="cursor: pointer;"></i>
            </div>
            </div>

          </div>

          <div style="margin-left: 300px;">
            <h2 style="color: rgb(187, 187, 187);">Create a New Company or Subcontractor Group</h2>
            <p style="color: white;">Current Fleetpay Instance: <span style="color: rgb(107, 251, 189); font-weight: bold;">SUDO</span></p>
            <hr style="color: white; width: 85%;">
            <p style="color: white; width: 80%;">Please note that a company must be created before its respective users can be created, even in the case of single person sole proprietorships. Direct Company employees can be added underneath the highest parent in a group. Example: Incredible Installations would be the parent company for Luke Grant. </p>
            <p style="color: white; width: 80%;">For more information and FAQ, please visit our <a href="ReportIssue.html" style="color: rgb(188, 171, 240);">Help Page</a>
        </div>


      <!-- Create a company form -->
      <div class="container mt-5" style="width: 70%; 
      margin-left: 300px; align-items: center;">
        <div class="card shadow rounded-4">
          <div class="card-body" style="background-color: #e2eeff;">
            <!-- <h3 class="card-title mb-4 text-center text-primary">Register a New Company</h3> -->
             <br>
      
            <form id="addCompanyForm">
              <div class="mb-3">
                <label for="companyName" class="form-label">Company Name</label>
                <input type="text" class="form-control" id="companyName" required>
              </div>
      
              <div class="mb-3">
                <label for="primaryContact" class="form-label">Primary Contact Name</label>
                <input type="text" class="form-control" id="primaryContact" required>
              </div>
      
              <div class="mb-3">
                <label for="primaryID" class="form-label">Primary Contact User ID</label>
                <input type="number" class="form-control" id="primaryID" required>
              </div>
      
              <div class="mb-3">
                <label for="paymentInterval" class="form-label">Payment Interval</label>
                <select class="form-select" id="paymentInterval" required>
                  <option value="">Choose...</option>
                  <option value="Weekly">Weekly</option>
                  <option value="Biweekly">Biweekly</option>
                  <option value="Monthly">Monthly</option>
                </select>
              </div>
      
              <div class="mb-3">
                <label for="companyEmail" class="form-label">Company Email</label>
                <input type="email" class="form-control" id="companyEmail" required>
              </div>
      
              <div class="mb-3">
                <label for="companyPhone" class="form-label">Company Phone</label>
                <input type="tel" class="form-control" id="companyPhone">
              </div>
      
              <div class="mb-3">
                <label for="status" class="form-label">Company Status</label>
                <select class="form-select" id="status" required>
                  <option value="">Choose...</option>
                  <option value="Active">Active</option>
                  <option value="Inactive">Inactive</option>
                  <option value="Onboarding">Onboarding</option>
                  <option value="Terminated">Terminated</option>
                  <option value="Prospect">Prospect</option>
                  <option value="Under Review">Under Review</option>
                </select>
              </div>
      
              <div class="form-check mb-3">
                <input class="form-check-input pulse-border" type="checkbox" id="twoFactor">
                <label class="form-check-label" for="consentCheckbox">
                  Two-Factor Authentication Required
                </label>
              </div>
      
              <div class="mb-4">
                <label for="notes" class="form-label">Notes</label>
                <textarea class="form-control" id="notes" rows="3"></textarea>
              </div>
      
              <div class="d-grid">
                <button type="submit" class="btn btn-secondary btn-lg">Add Company</button>
              </div>
            </form>
          </div>
        </div>

      


    </div>

    <!-- Current Companies table -->
    <div class="container mt-5" style="width: 70%; 
      margin-left: 300px; align-items: center;">
      <div class="card shadow rounded-4">
        <div class="card-body" style="background-color: #e2eeff;">
          <h3 class="card-title mb-4 text-center text-primary">All Companies & Sub Groups</h3>
          <p class="text-center" style="color: rgb(43, 43, 43);">Current Instance: <span style="color: rgb(29, 26, 112); font-weight: bold;">SUDO / All</span></p>


    
          <div id="companyList" class="row g-4">
            <!-- Company cards will be injected here -->
          </div>
        </div>
      </div>
    </div>

    <div id="myfooter">

      <br>
      <div class="text-center">
        <hr style="color: white; width: 70%; margin-left: 300px; align-content: center;">
      </div>
      <div class="text-center" style="font-size: large; color: rgb(192, 191, 191); font-weight: bold;">Fleetpay.cash — A GenX Company — Ellis Ventures 2025 ~ JW</div>
      <br><br>
      
    </div>


<!-- <footer class="footer mt-5 py-3 text-center" style="margin-left: 250px; width: 80%;">
      <div class="container text-center">
        <small>Fleetpay.cash — A GenX Company — Ellis Ventures 2025 ~ JW</small>
      </div>
    </footer> -->
    
    <!-- Script to adjust footer based on sidebar -->
    <script>
function adjustFooterMargin() {
  const isCollapsed = sidebar.classList.contains('collapsed');
  footer.style.marginLeft = isCollapsed ? '80px' : '250px';
}
    </script>

    <script>
      async function loadCompanyList() {
        try {
          const response = await fetch('http://localhost:3000/Companies');
          if (!response.ok) throw new Error("Failed to fetch companies.");
    
          const companies = await response.json();
          const listContainer = document.getElementById('companyList');
          const container = document.getElementById('companyList');
  container.innerHTML = '';

  companies.forEach(company => {
  const card = document.createElement('div');
  card.className = 'col-md-6 mb-3 company-card';
  card.dataset.company = JSON.stringify(company);

  card.innerHTML = `
    <div class="border rounded p-3 bg-light shadow-sm d-flex justify-content-between align-items-center">
      <div>
        <h5 class="text-dark text-center"><strong>${company.CompanyName}</strong></h5>
        <hr>
        <p><strong>Contact:</strong> ${company.PrimaryContact || 'undefined'}</p>
        <p><strong>Email:</strong> ${company.CompanyEmail || 'undefined'}</p>
        <p><strong>Phone:</strong> ${company.CompanyPhone || 'N/A'}</p>
        <p><strong>Status:</strong> ${company.Status || 'undefined'}</p>
        <p><strong>Payment:</strong> ${company.PaymentInterval || 'undefined'}</p>
      </div>
      <div>
        <img src="/img/group.png" alt="Company Icon" style="height: 80px; width: auto;">
      </div>
    </div>
  `;

  container.appendChild(card);
});


  attachCompanyCardListeners();
    
        } catch (err) {
          console.error('Error loading companies:', err);
        }
      }
    
      // Load companies on page load
      document.addEventListener('DOMContentLoaded', loadCompanyList);
    </script>
    
    

      <!-- Javascript to toggle sidebar -->
      <script>
        document.getElementById('toggleSidebar').addEventListener('click', () => {
        const sidebar = document.getElementById('sidebar');
        sidebar.classList.toggle('collapsed');
        const isCollapsed = sidebar.classList.contains('collapsed');
        adjustFooterMargin(isCollapsed);
        });
    </script>
  




  
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('addCompanyForm');
  
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
  
        const companyData = {
          companyName: document.getElementById("companyName").value,
          primaryContact: document.getElementById("primaryContact").value,
          primaryID: parseInt(document.getElementById("primaryID").value),
          paymentInterval: document.getElementById("paymentInterval").value,
          companyEmail: document.getElementById("companyEmail").value,
          companyPhone: document.getElementById("companyPhone").value,
          status: document.getElementById("status").value,
          twoFactor: document.getElementById("twoFactor").checked,
          notes: document.getElementById("notes").value
        };
  
        try {
          const response = await fetch('http://localhost:3000/Companies', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(companyData)
          });
  
          if (!response.ok) {
            throw new Error('Failed to add company');
          }
  
          const result = await response.json();
          alert(result.message);
          form.reset();
  
          // 👇 Refresh the company list display
          loadCompanyList();
  
        } catch (error) {
          console.error('❌ Error:', error);
          alert('There was an error creating the company.');
        }
      });
    });
  </script>


<!-- Modal -->
 <script>

// Step 1: Add Modal HTML (include somewhere in your CompaniesAdmin.html)
const modalHTML = `
<div class="modal fade" id="editCompanyModal" tabindex="-1" aria-labelledby="editCompanyModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editCompanyModalLabel">Edit Company Info</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="editCompanyForm">
          <input type="hidden" id="editCompanyID" />

          <div class="mb-3">
            <label for="editCompanyName" class="form-label">Company Name</label>
            <input type="text" class="form-control" id="editCompanyName">
          </div>

          <div class="mb-3">
            <label for="editPrimaryContact" class="form-label">Primary Contact</label>
            <input type="text" class="form-control" id="editPrimaryContact">
          </div>

          <div class="mb-3">
            <label for="editCompanyEmail" class="form-label">Email</label>
            <input type="email" class="form-control" id="editCompanyEmail">
          </div>

          <div class="mb-3">
            <label for="editCompanyPhone" class="form-label">Phone</label>
            <input type="text" class="form-control" id="editCompanyPhone">
          </div>

          <div class="mb-3">
            <label for="editStatus" class="form-label">Status</label>
            <select id="editStatus" class="form-select">
              <option value="Active">Active</option>
              <option value="Inactive">Inactive</option>
              <option value="Onboarding">Onboarding</option>
              <option value="Terminated">Terminated</option>
              <option value="Prospect">Prospect</option>
              <option value="Under Review">Under Review</option>
            </select>
          </div>

          <div class="mb-3">
            <label for="editPaymentInterval" class="form-label">Payment Interval</label>
            <input type="text" class="form-control" id="editPaymentInterval">
          </div>

          <div class="mb-3">
            <label for="editNotes" class="form-label">Notes</label>
            <textarea class="form-control" id="editNotes" rows="3"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="submit" class="btn btn-primary" id="saveCompanyBtn" form="editCompanyForm">Save Changes</button>
      </div>
    </div>
  </div>
</div>`;

document.body.insertAdjacentHTML('beforeend', modalHTML);


// Step 2: Add click event to each company card
function attachCompanyCardListeners() {
  const companyCards = document.querySelectorAll('.company-card');
  companyCards.forEach(card => {
    card.addEventListener('click', () => {
      const company = JSON.parse(card.dataset.company);

      document.getElementById('editCompanyID').value = company.CompanyID;
      document.getElementById('editCompanyName').value = company.CompanyName;
      document.getElementById('editPrimaryContact').value = company.PrimaryContact;
      document.getElementById('editCompanyEmail').value = company.CompanyEmail;
      document.getElementById('editCompanyPhone').value = company.CompanyPhone;
      document.getElementById('editStatus').value = company.Status;
      document.getElementById('editPaymentInterval').value = company.PaymentInterval;
      document.getElementById('editNotes').value = company.Notes || '';

      const modal = new bootstrap.Modal(document.getElementById('editCompanyModal'));
      modal.show();
    });
  });
}


// Step 3: Update renderCompanyCards to include dataset
function renderCompanyCards(companies) {
  const container = document.getElementById('companyList');
  container.innerHTML = '';

  companies.forEach(company => {
    const card = document.createElement('div');
    card.className = 'col-md-6 mb-3 company-card';
    card.dataset.company = JSON.stringify(company);
    card.innerHTML = `
      <div class="border rounded p-3 bg-light shadow-sm">
        <h5 class="text-dark">${company.CompanyName}</h5>
        <p><strong>Contact:</strong> ${company.PrimaryContact || 'undefined'}</p>
        <p><strong>Email:</strong> ${company.CompanyEmail || 'undefined'}</p>
        <p><strong>Phone:</strong> ${company.CompanyPhone || 'N/A'}</p>
        <p><strong>Status:</strong> ${company.Status || 'undefined'}</p>
        <p><strong>Payment:</strong> ${company.PaymentInterval || 'undefined'}</p>
      </div>
    `;

    container.appendChild(card);
  });

  attachCompanyCardListeners();
  console.log("yes")
}




 </script>



<script>

document.getElementById('saveCompanyBtn').addEventListener('click', async () => {
  const companyId = document.getElementById('companyModal').getAttribute('data-id');

  const updatedData = {
    CompanyName: document.getElementById('companyNameInput').value,
    PrimaryContact: document.getElementById('primaryContactInput').value,
    PrimaryID: document.getElementById('primaryIDInput').value,
    PaymentInterval: document.getElementById('paymentIntervalInput').value,
    CompanyEmail: document.getElementById('companyEmailInput').value,
    CompanyPhone: document.getElementById('companyPhoneInput').value,
    Status: document.getElementById('companyStatusInput').value,
    TwoFactorEnabled: document.getElementById('twoFactorEnabledInput').checked,
    Notes: document.getElementById('companyNotesInput').value,
  };

  try {
    const response = await fetch(`http://localhost:3000/Companies/${companyId}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(updatedData)
    });

    if (response.ok) {
      alert("Company updated successfully!");
      document.getElementById('companyModalCloseBtn').click();
      loadCompanies(); // Re-fetch and refresh the cards
    } else {
      const error = await response.json();
      alert("Update failed: " + (error.error || 'Unknown error'));
    }
  } catch (err) {
    console.error(err);
    alert("An error occurred while saving changes.");
  }
});


</script>




  

</body>