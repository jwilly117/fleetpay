<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management üë∑‚Äç‚ôÇÔ∏è</title>

    <!-- Placeholder link to React / Bootstrap -->

    <!-- Link local CSS Sheet -->

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <link rel="stylesheet" href="/css/style.css">

    <style>
        /* Customize table-active class for light yellow background */
        .table-active {
            background-color: #d3b140 !important; /* Light yellow */
            --bs-table-bg-state: rgb(166, 166, 255);
        }
        body{
            /* background-color: rgb(196, 225, 255); */
        }
         /* Highlight cells in light pink */
         .highlight-pink {
            background-color: #f2c4c4 !important; /* Light pink */
        }
        /* Toast top right */
        .toast-container {
            position: fixed;
            top: 10%;
            right: 5%;
        }
        /* Custom background for the toast */
        .toast-light-blue {
            background-color: #a9eefa !important; /* Light blue */
            color: #0c5460; /* Dark text to match light blue */
            box-shadow: 0 8px 10px rgba(0, 0, 0, 0.4), 0 6px 20px rgba(0, 0, 0, 0.39); /* Drop shadow */

        }
        /* Breathing glow effect for input field */
        @keyframes breathingGlow {
            0% {
                box-shadow: 0 0 10px rgba(0, 38, 255, 0.5);
            }
            50% {
                box-shadow: 0 0 30px rgba(0, 38, 255, 0.9);
            }
            100% {
                box-shadow: 0 0 10px rgba(0, 38, 255, 0.5);
            }
        }
        .glow-input {
            animation: breathingGlow 2s infinite;
            border: 1px solid rgba(0, 38, 255, 0.5);
        }

        /* Row slide-down animation */
        @keyframes slideDown {
            0% {
                transform: translateY(-20px);
                opacity: 0;
            }
            100% {
                transform: translateY(0);
                opacity: 1;
            }
        }
        .slide-down {
            animation: slideDown 0.5s ease-out;
        }
        .non-selectable {
            background-color: #7314144c !important; /* Light pink for non-selectable rows */
            pointer-events: none; /*  Disable Selection */
        }
        /* Strobe and glow animation for "Scheduled" cells */
        @keyframes strobeGlow {
            0%, 100% {
                box-shadow: 0 0 10px rgba(255, 0, 0, 0.5), 0 0 20px rgba(255, 0, 0, 0.8);
                background-color: #ffe6e6;
            }
            50% {
                box-shadow: 0 0 20px rgba(255, 0, 0, 1), 0 0 40px rgba(255, 0, 0, 1);
                background-color: #ffcccc;
            }
        }
        .strobe-glow {
            animation: strobeGlow 2s infinite;
        }        


    </style>

<style>
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
    }
    th {
      background-color: #f2f2f2;
    }
    button {
      padding: 5px 10px;
      background-color: #e74c3c;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background-color: #c0392b;
    }
    .approve-btn {
      background-color: #1f7a45;
      color: white;
    }
    .approve-btn:hover {
      background-color: #27ae60;
    }
        /* Animation styles */
        tbody tr {
      opacity: 1;
      transform: translateY(20px);
      transition: opacity 0.5s ease, transform 0.5s ease;
    }
    tbody tr.visible {
      opacity: 1;
      transform: translateY(0);
    }
  </style>
</head>
<body>

    <!-- Main page header -->
    <div class="page-header" style="padding-top: 15px;">
        <img src="/img/fleetpay_dark.jpg" alt="" style="height: 50px;">
        <p style="font-size: 14px;">Sql Database Testing Environment</p>
    </div>

    
    <br><br>
    <!-- Toggle Button -->
    <button id="toggleSidebar" class="btn btn-secondary" style="position: fixed; top: 20px; left: 20px; z-index: 999; background-color: #0e6170;">
        <i class="fas fa-bars"></i>
    </button>
  

    <!-- Sidebar -->
    <!-- Font Awesome CDN for icons (add in <head> if not already included) -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

        <div class="sidebar" id="sidebar">

            <div class="sidebar-content">
              <br><br>
              <h3 class="section-header" style="text-align: center; text-decoration: wavy;">Main Menu</h3><br>
              <a href="Dashboard.html" style="text-align: center; background-color: #416682;"><strong>üí∏ My Dashboard</strong></a>
              <hr  class="section-header">
              <h6 class="section-header" style="color: lightgray; font-weight: bolder;">Requests</h6>

              <a href="CreateRequest.html">üî∏Create Request</a>
              <a href="ReviewRequest.html">üî∏Review Requests</a>
              <a href="ReportIssue.html">üî∏Help or Report Issue</a>

              <h6 class="section-header" style="color: lightgray; font-weight: bolder;">Management</h6>

              <a href="CompaniesAdmin.html">üî∏Company Admin</a>
              <a href="UsersAdmin.html" style="background-color: #035b6a;">üî∏User Admin</a>
              <a href="BankLinking.html">üî∏Banking Admin</a>
              <h6 class="section-header" style="color: lightgray; font-weight: bolder;">Financial Records</h6>

              <a href="Payrollexclude.html">üî∏Payroll Exclusions</a>
              <a href="ArchiveRecords.html">üî∏Payout Archives</a>
              <a href="settings.html">üî∏Settings</a>
              <a href="contact.html"> üî∏More Info</a>

            </div>
          
            <!-- Moved to bottom -->
            <div class="user-panel">
              <i class="fas fa-user-circle fa-2x me-2"></i>
              
            <div class="user-info">
                <div><strong>Jake W.</strong></div>
                <div style="font-size: 0.85em;">
                    <i class="fas fa-badge-check" style="color: limegreen;"></i> Verified
                  </div>
                </div>

            <div class="user-actions">
                <i class="fas fa-cog mx-2" title="Settings"></i>
                <i class="fas fa-sign-out-alt" title="Logout" onclick="logoutUser()" style="cursor: pointer;"></i>
            </div>
            </div>

          </div>

          <div style="margin-left: 300px;">
            <h2 style="color: rgb(187, 187, 187);">Create a New User or Group Administrator</h2>
            <p style="color: white;">Current Fleetpay Instance: <span style="color: rgb(107, 251, 189); font-weight: bold;">SUDO</span></p>
            <hr style="color: white; width: 85%;">
            <p style="color: white;">Note that a users company has to be created before its users. To create a company, <a href="CompaniesAdmin.html" style="color: rgb(188, 171, 240);">Go Here. </a>Always ensure the correct company <br> and apppropriate role are applied to the user upon creation.</p>
            <p style="color: white; width: 80%;">For more information and FAQ, please visit our <a href="ReportIssue.html" style="color: rgb(188, 171, 240);">Help Page</a>

        </div>

    <!-- Create User form -->
    <div class="container mt-5" style="width: 70%; 
    margin-left: 300px; align-items: center;">
    
            <div class="card shadow rounded-4">
              <div class="card-body" style="background-color: #e2eeff;">
                <!-- <h3 class="card-title mb-4 text-center text-primary">Add a New User</h3> -->
                <br>
                <form id="addUserForm">
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label for="firstName" class="form-label">First Name</label>
                      <input type="text" class="form-control" id="firstName" required>
                    </div>
                    <div class="col-md-6 mb-3">
                      <label for="lastName" class="form-label">Last Name</label>
                      <input type="text" class="form-control" id="lastName" required>
                    </div>
                  </div>
          
                  <div class="mb-3">
                    <label for="emailAddress" class="form-label">Email Address</label>
                    <input type="email" class="form-control" id="emailAddress" required>
                  </div>
          
                  <div class="mb-3">
                    <label for="phoneNumber" class="form-label">Phone Number</label>
                    <input type="tel" class="form-control" id="phoneNumber">
                  </div>
          
                  <div class="mb-3">
                    <label for="role" class="form-label">Role</label>
                    <input type="text" class="form-control" id="role" placeholder="e.g., Admin, Contractor, etc.">
                  </div>
          
                  <div class="mb-3">
                    <label for="password" class="form-label">Temporary Password</label>
                    <input type="password" class="form-control" id="password" required>
                  </div>
          
                  <div class="mb-3">
                    <label for="employerSelect" class="form-label">Employer (Company)</label>
                    <select class="form-select" id="employerSelect" required>
                      <option value="">Select...</option>
                      <!-- You can dynamically populate these options with JS -->
                    </select>
                  </div>
          
                  <div class="form-check mb-3">
                    <input class="form-check-input pulse-border" type="checkbox" id="twoFactor">
                    <label class="form-check-label" for="twoFactor">üì± Enable 2-Factor</label>
                  </div>
          
                  <div class="form-check mb-4">
                    <input class="form-check-input pulse-border" type="checkbox" id="bankAccountAdded">
                    <label class="form-check-label" for="bankAccountAdded">üí∏ Direct Deposit Received </label>
                  </div>
          
                  <div class="d-grid">
                    <button type="submit" class="btn btn-secondary btn-lg">Create User</button>
                  </div>
                </form>
              </div>
            </div>
    </div>

    <!-- List all Users -- Include a filter by company / sub soon -->
    <div class="container mt-5" style="width: 70%; 
    margin-left: 300px; align-items: center;">
      <div class="card shadow rounded-4">
        <div class="card-body" style="background-color: #e2eeff;">
          <h3 class="card-title mb-4 text-center text-primary">Current Users Within Scope</h3>

          <div class="mb-3 text-center">
            <label for="employerFilter" class="form-label fw-bold text-dark">Filter by Employer ID:</label>
            <select id="employerFilter" class="form-select w-auto d-inline-block">
              <option value="all" selected>View All</option>
              <option value="1">Stark Industries #1</option>
              <option value="2">Oscorp #2</option>
              <option value="3">Roxxon Energy Corp #3</option>
              <option value="4">Hammer Industries #4</option>
              <option value="5">S.H.I.E.L.D. #5</option>
              <option value="6">Wakandan Design Group #6</option>
              <option value="7">Xavier Institute #7</option>
              <option value="8">Daily Bugle LLC #8</option>
              <option value="9">Incredible Installations #9</option>
              <option value="10">Fire-Ballz #10</option>
            </select>
          </div>
          
    
          <div id="userList" class="row g-4">
            <!-- User cards will be injected here -->
          </div>
        </div>
      </div>
    </div>

    <br><br>
    
          

          <script>
            document.addEventListener('DOMContentLoaded', () => {
              const form = document.getElementById('addUserForm');
          
              form.addEventListener('submit', async (e) => {
                e.preventDefault();
          
                const userData = {
                  firstName: document.getElementById("firstName").value,
                  lastName: document.getElementById("lastName").value,
                  email: document.getElementById("emailAddress").value,
                  phone: document.getElementById("phoneNumber").value,
                  role: document.getElementById("role").value,
                  password: document.getElementById("password").value,
                  employerID: parseInt(document.getElementById("employerSelect").value),
                  twoFactor: document.getElementById("twoFactor").checked,
                  bankAdded: document.getElementById("bankAccountAdded").checked
                };
          
                try {
                  const response = await fetch('http://localhost:3000/Users', {
                    method: 'POST',
                    headers: {
                      'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(userData)
                  });
          
                  if (!response.ok) {
                    throw new Error('Failed to create user');
                  }
          
                  const result = await response.json();
                  alert(result.message);

                  loadUserList();

                  form.reset(); // Optional: clears the form
                } catch (error) {
                  console.error('Error creating user:', error);
                  alert('‚ùå There was an error creating the user.');
                }
              });
            });
          </script>
          



          <script>
            // Function to populate the Employer dropdown with companies from the backend
            async function populateEmployerDropdown() {
              try {
                const response = await fetch('http://localhost:3000/Companies');
                if (!response.ok) {
                  throw new Error('Network response was not ok');
                }
                const companies = await response.json();
                const employerSelect = document.getElementById('employerSelect');
          
                // Clear any existing options (except the default)
                employerSelect.innerHTML = '<option value="">Select a company...</option>';
          
                // Populate the dropdown with options
                companies.forEach(company => {
                  const option = document.createElement('option');
                  option.value = company.CompanyID; // or the relevant identifier
                  option.textContent = company.CompanyName;
                  employerSelect.appendChild(option);
                });
              } catch (error) {
                console.error('Error populating employer dropdown:', error);
              }
            }
          
            // Call the function on page load
            window.addEventListener('DOMContentLoaded', populateEmployerDropdown);
          </script>
          

          <script>
            let allUsers = [];
          
            async function loadUserList() {
              try {
                const response = await fetch('http://localhost:3000/Users');
                if (!response.ok) throw new Error("Failed to fetch users.");
                allUsers = await response.json();
                renderUserCards(allUsers);
              } catch (err) {
                console.error('Error loading users:', err);
              }
            }

            function openEditModal(user) {
  document.getElementById('editUserId').value = user.IDNumber;
  document.getElementById('editFirstName').value = user.FirstName;
  document.getElementById('editLastName').value = user.LastName;
  document.getElementById('editEmail').value = user.EmailAddress;
  document.getElementById('editPhone').value = user.PhoneNumber || '';
  document.getElementById('editRole').value = user.Role;
  document.getElementById('editStatus').value = user.Status || 'Active';

  const modal = new bootstrap.Modal(document.getElementById('editUserModal'));
  modal.show();
}
          
            function renderUserCards(users) {
              const listContainer = document.getElementById('userList');
              listContainer.innerHTML = '';

              users.forEach(user => {
                const col = document.createElement('div');
                col.className = 'col-md-6';

                col.innerHTML = `
                <div class="border rounded p-3 bg-light shadow-sm d-flex justify-content-between align-items-center user-card" style="cursor: pointer;" onclick='openEditModal(${JSON.stringify(user)})'>
                    <div>
                      <h5 class="text-dark mb-1">${user.FirstName} ${user.LastName}</h5>
                      <p class="mb-1"><strong>Email:</strong> ${user.EmailAddress}</p>
                      <p class="mb-1"><strong>Phone:</strong> ${user.PhoneNumber || 'N/A'}</p>
                      <p class="mb-1"><strong>Role:</strong> ${user.Role}</p>
                      <p class="mb-1"><strong>Company:</strong> ${user.EmployerID ?? 'Unassigned'}</p>
                      <p class="mb-1"><strong>2FA:</strong> ${user.TwoFactorEnabled ? 'Enabled' : 'Disabled'}</p>
                      <p class="mb-1"><strong>Status:</strong> ${user.Status}</p>
                    </div>
                    <div>
                      <img src="https://cdn-icons-png.flaticon.com/512/149/149071.png" alt="User Icon" style="height: 150px;">
                    </div>
                  </div>
                `;

                // Click event to open modal
                // col.querySelector('.user-card').addEventListener('click', () => {
                //   document.getElementById('modalUserName').textContent = `${user.FirstName} ${user.LastName}`;
                //   document.getElementById('modalUserEmail').textContent = user.EmailAddress;
                //   document.getElementById('modalUserPhone').textContent = user.PhoneNumber || 'N/A';
                //   document.getElementById('modalUserRole').textContent = user.Role;
                //   document.getElementById('modalUserCompany').textContent = user.EmployerID ?? 'Unassigned';
                //   document.getElementById('modalUserStatus').textContent = user.Status;

                //   // Show modal
                //   const userModal = new bootstrap.Modal(document.getElementById('userModal'));
                //   userModal.show();
                // });



                document.getElementById('editUserForm').addEventListener('submit', async function (e) {
                  e.preventDefault();

                  const updatedUser = {
                    FirstName: document.getElementById('editFirstName').value,
                    LastName: document.getElementById('editLastName').value,
                    EmailAddress: document.getElementById('editEmail').value,
                    PhoneNumber: document.getElementById('editPhone').value,
                    Role: document.getElementById('editRole').value,
                    Status: document.getElementById('editStatus').value,
                  };

                  const userId = document.getElementById('editUserId').value;

                  try {
                    const response = await fetch(`http://localhost:3000/Users/${userId}`, {
                      method: 'PUT',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify(updatedUser)
                    });

                    if (response.ok) {
                      alert('User updated successfully!');
                      const modal = bootstrap.Modal.getInstance(document.getElementById('editUserModal'));
                      modal.hide();
                      loadUserList();
                    } else {
                      alert('Failed to update user.');
                    }
                  } catch (err) {
                    console.error('Error updating user:', err);
                    alert('An error occurred.');
                  }
                });


                listContainer.appendChild(col);
              });
            }




          
            // Event listener for the dropdown
            document.getElementById('employerFilter').addEventListener('change', function () {
              const selected = this.value;
              if (selected === 'all') {
                renderUserCards(allUsers);
              } else {
                const filtered = allUsers.filter(user => user.EmployerID == selected);
                renderUserCards(filtered);
              }
            });
          
            // Load users on page ready
            document.addEventListener('DOMContentLoaded', loadUserList);
          </script>
          


      <!-- Javascript to toggle sidebar -->
      <script>
        document.getElementById('toggleSidebar').addEventListener('click', () => {
        const sidebar = document.getElementById('sidebar');
        sidebar.classList.toggle('collapsed');
        });
    </script>


<!-- Edit User Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <form id="editUserForm">
        <div class="modal-header">
          <h5 class="modal-title" id="editUserModalLabel">Edit User Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="editUserId">
          <div class="mb-3">
            <label for="editFirstName" class="form-label">First Name</label>
            <input type="text" class="form-control" id="editFirstName" required>
          </div>
          <div class="mb-3">
            <label for="editLastName" class="form-label">Last Name</label>
            <input type="text" class="form-control" id="editLastName" required>
          </div>
          <div class="mb-3">
            <label for="editEmail" class="form-label">Email Address</label>
            <input type="email" class="form-control" id="editEmail" required>
          </div>
          <div class="mb-3">
            <label for="editPhone" class="form-label">Phone Number</label>
            <input type="text" class="form-control" id="editPhone">
          </div>
          <div class="mb-3">
            <label for="editRole" class="form-label">Role</label>
            <input type="text" class="form-control" id="editRole">
          </div>
          <div class="mb-3">
            <label for="editStatus" class="form-label">Status</label>
            <select class="form-select" id="editStatus">
              <option value="Active">Active</option>
              <option value="Inactive">Inactive</option>
              <option value="Suspended">Suspended</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success">Save Changes</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>


  
  <div id="myfooter">
    
    <br>
    <div class="text-center">
      <hr style="color: white; width: 70%; margin-left: 300px; align-content: center;">
    </div>
    <div class="text-center" style="font-size: large; color: rgb(192, 191, 191); font-weight: bold;">Fleetpay.cash ‚Äî A GenX Company ‚Äî Ellis Ventures 2025 ~ JW</div>
    <br><br>
    
  </div>

</body>