<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Information</title>

    <!-- Placeholder link to React / Bootstrap -->

    <!-- Link local CSS Sheet -->


    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <link rel="stylesheet" href="css/style.css">

    <style>
        /* Customize table-active class for light yellow background */
        .table-active {
            background-color: #d3b140 !important; /* Light yellow */
            --bs-table-bg-state: rgb(166, 166, 255);
        }
        body{
            /* background-color: rgb(196, 225, 255); */
        }
         /* Highlight cells in light pink */
         .highlight-pink {
            background-color: #f2c4c4 !important; /* Light pink */
        }
        /* Toast top right */
        .toast-container {
            position: fixed;
            top: 10%;
            right: 5%;
        }
        /* Custom background for the toast */
        .toast-light-blue {
            background-color: #a9eefa !important; /* Light blue */
            color: #0c5460; /* Dark text to match light blue */
            box-shadow: 0 8px 10px rgba(0, 0, 0, 0.4), 0 6px 20px rgba(0, 0, 0, 0.39); /* Drop shadow */

        }
        /* Breathing glow effect for input field */
        @keyframes breathingGlow {
            0% {
                box-shadow: 0 0 10px rgba(0, 38, 255, 0.5);
            }
            50% {
                box-shadow: 0 0 30px rgba(0, 38, 255, 0.9);
            }
            100% {
                box-shadow: 0 0 10px rgba(0, 38, 255, 0.5);
            }
        }
        .glow-input {
            animation: breathingGlow 2s infinite;
            border: 1px solid rgba(0, 38, 255, 0.5);
        }

        /* Row slide-down animation */
        @keyframes slideDown {
            0% {
                transform: translateY(-20px);
                opacity: 0;
            }
            100% {
                transform: translateY(0);
                opacity: 1;
            }
        }
        .slide-down {
            animation: slideDown 0.5s ease-out;
        }
        .non-selectable {
            background-color: #7314144c !important; /* Light pink for non-selectable rows */
            pointer-events: none; /*  Disable Selection */
        }
        /* Strobe and glow animation for "Scheduled" cells */
        @keyframes strobeGlow {
            0%, 100% {
                box-shadow: 0 0 10px rgba(255, 0, 0, 0.5), 0 0 20px rgba(255, 0, 0, 0.8);
                background-color: #ffe6e6;
            }
            50% {
                box-shadow: 0 0 20px rgba(255, 0, 0, 1), 0 0 40px rgba(255, 0, 0, 1);
                background-color: #ffcccc;
            }
        }
        .strobe-glow {
            animation: strobeGlow 2s infinite;
        }        


    </style>
</head>
<body>

    <!-- Main page header -->
    <div class="page-header" style="padding-top: 15px;">
        <img src="img/fleetpay_dark.jpg" alt="" style="height: 50px;">
        <p style="font-size: 14px;">Sql Database Testing Environment</p>
    </div>

    
    <br><br>

    <!-- Sidebar -->
    <div class="sidebar" style="margin-top: 125px;">
        <h2>Main Menu</h2>
        <a href="#link1">Users</a>
        <a href="#link2">Companies</a>
        <a href="#link3">Lookup Jobs</a>
        <a href="#link4">Payouts</a>
        <a href="#link5">Assets</a>
        <a href="#link5">Assets</a>
        <a href="#link5">Assets</a>
        <a href="#link5">Assets</a>
    </div>


    <div class="container" id="maincontain" style="background-color: rgb(78, 108, 135); width: 80%; margin-left: 355px; align-items: center;">
        <div class="row">
          <div class="col-md-4">
            <div class="container">
                <div class="header">User Information</div>
                <div class="customer-info">
                    <p><strong>User # / ID:</strong> <span id="customer-id">...</span></p>
                    <p><strong>First Name:</strong> <span id="customer-first-name">...</span></p>
                    <p><strong>Last Name:</strong> <span id="customer-last-name">...</span></p>
                    <p><strong>Email:</strong> <span id="customer-email">...</span></p>
                    <p><strong>Phone:</strong> <span id="customer-phone">...</span></p>
                    <button class="delete-button" id="delete-button" style="display: none;">Delete Record</button>
        
                </div>
            </div>
        
            <!-- =========================================================================== -->
        
            <!-- Records container -->
            <div class="records-container container" id="records-container">
                
                <h3>All Customers</h3>
                <p>Click on a customer to view their details above:</p>
            </div>

          
          </div>

          <div class="col-md-8">
            <div class="container" id="Additional" style="width: 95%;">
                <div class="header">Additional Info</div>
                <div class="customer-info">
                    <img src="img/fdsafsf.png" style="width: 20%;" alt="Employee Pic Placeholder"> <span style="margin-left: 15px;">User Information & More</span>
                    <hr>
                    <p>Lorem ipsum dolor sit amet consectetur adipisicing elit. Ipsa cupiditate maxime libero vero nam, corrupti ullam magnam commodi aperiam accusantium optio nesciunt. Quasi eius reiciendis, placeat exercitationem unde architecto et.</p>
                    <hr>
                    <p>Lorem ipsum, dolor sit amet consectetur adipisicing elit. Sit eos vitae repellendus placeat sapiente rerum corrupti adipisci consequatur quo, cupiditate commodi dignissimos inventore architecto nostrum, deserunt eius recusandae minima similique.</p>
                    <p>Lorem ipsum dolor sit amet consectetur adipisicing elit. Ipsa cupiditate maxime libero vero nam, corrupti ullam magnam commodi aperiam accusantium optio nesciunt. Quasi eius reiciendis, placeat exercitationem unde architecto et.</p>
                    <hr>
                    <p>Lorem ipsum dolor sit amet consectetur adipisicing elit. Ipsa cupiditate maxime libero vero nam, corrupti ullam magnam commodi aperiam accusantium optio nesciunt. Quasi eius reiciendis, placeat exercitationem unde architecto et.</p>
                    <hr>
                    <span style="font-size: small; font-weight: bold;">2024 Work In Progress - JW</span>

        
                </div>
                
            </div>


          </div>
          <div>
            <br>
            <a  href="insert.html" style="color: white; text-align: center; margin-left: 45%;">Go to Insert Page</a><br>

            
        </div>
        <br><br>
        <hr>
        <br>
        <hr>
        <div class="container mt-5">
            <h1 class="text-center mb-4">Create Payment Request</h1>
            <div class="card">
                <div class="card-body">
                    <form id="uploadForm">
                        <div class="mb-3">
                            <label for="fileInput" class="form-label">Choose an XLSX file</label>
                            <input class="form-control" type="file" id="fileInput" accept=".xlsx">
                        </div>
                        <button type="button" class="btn btn-secondary" id="parseButton">Load My Jobs</button>
                    </form>
                </div>
            </div>
            <div class="mt-4">
                <h3>Job Data</h3>
                <p>Please review and select your completed jobs from the table below. Please note, if a job is still
                     in a status of "Scheduled", it will not be approved for payout. These jobs will be hightlighted i
                    n Red. We encourage you to use the included link to the job and perform necessary actions to bring it to a close and
                     make it available for payout. 
                </p>
                <button class="btn btn-secondary mb-3" id="selectAllButton">Select All Jobs</button>
                <button class="btn btn-secondary mb-3 ms-2" id="selectNoneButton">Select None</button>
                <table class="table table-bordered table-striped" id="xlsxTable">
                    <thead id="tableHead"></thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
            <div class="mt-4">
                <label for="totalField" class="form-label">Total Selected Labor:</label>
                <input type="text" id="totalField" class="form-control" readonly>
            </div>
            <div class="mt-3">
                <label for="percentageField" class="form-label">Fleetpay Immediate Payout amount:</label>
                <input type="text" id="percentageField" class="form-control" readonly>
            </div>
            <div class="mt-4 text-center">
                <button class="btn btn-secondary" id="googleButton" data-bs-toggle="modal" data-bs-target="#googleModal">Submit for Payment</button>
            </div>
        </div>
    
        <hr>
        <br><br><br>
    
        <!-- Modal -->
        <div class="modal fade" id="googleModal" tabindex="-1" aria-labelledby="googleModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="googleModalLabel">Request Submission</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        Please review your amount before submitting a payment request. We will review and send you correspondance on your deposit to your email account shortly. 
                        <hr>
                        <div class="mb-3">
                            <label for="modalPercentageField" class="form-label" style="font-weight:bold;">Your Deposit Amount:</label>
                            <input type="text" style="font-weight: bold; text-align: center;" id="modalPercentageField" class="form-control glow-input" readonly>
                        </div>
                    </div>
                    
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" id="approveButton" data-bs-dismiss="modal">Submit Request</button>
                    </div>
                </div>
            </div>
        </div>
    
    
         <!-- Toast -->
         <div class="toast-container position-fixed bottom-0 end-0 p-3">
            <div id="successToast" class="toast align-items-center toast-light-blue border-0" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body">
                        <strong>✅ Request Submitted Successfully</strong>
                        <hr>
                        Receipt will be emailed with all information
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
        </div>
    
    


        </div>



    </div>
    <script>
        async function fetchAllCustomers() {
            try {
                // Fetch all records from the server
                const response = await fetch('http://localhost:3000/api/lowes');
                const customers = await response.json();

                const recordsContainer = document.getElementById('records-container');

                // Clear existing records
                recordsContainer.innerHTML = '<h3>All Customers</h3><p>Click on a customer to view their details above:</p>';

                // Populate the records container
                customers.forEach(customer => {
                    const recordDiv = document.createElement('div');
                    recordDiv.classList.add('record');
                    recordDiv.textContent = `${customer.customer_first_name} ${customer.customer_last_name}`;
                    
                    // Add a click event listener to populate fields
                    recordDiv.addEventListener('click', () => {
                        document.getElementById('customer-id').textContent = customer.customer_id;
                        document.getElementById('customer-first-name').textContent = customer.customer_first_name;
                        document.getElementById('customer-last-name').textContent = customer.customer_last_name;
                        document.getElementById('customer-email').textContent = customer.customer_email;
                        document.getElementById('customer-phone').textContent = customer.customer_phone;
                        document.getElementById('delete-button').style.display = 'block';
                        document.getElementById('delete-button').dataset.customerId = customer.customer_id; // Store customer ID in the button
                    });

                    recordsContainer.appendChild(recordDiv);
                });
            } catch (error) {
                console.error('Error fetching customers:', error);
                alert('Failed to load customer records.');
            }
        }



        async function deleteCustomer(customerId) {
            try {
                const response = await fetch(`http://localhost:3000/api/delete-customer/${customerId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    // alert('Customer deleted successfully!');
                    fetchAllCustomers(); // Refresh the list of customers
                    document.getElementById('customer-id').textContent = 'Click a record below';
                    document.getElementById('customer-first-name').textContent = 'Click a record below';
                    document.getElementById('customer-last-name').textContent = 'Click a record below';
                    document.getElementById('customer-email').textContent = 'Click a record below';
                    document.getElementById('customer-phone').textContent = 'Click a record below';
                    document.getElementById('delete-button').style.display = 'none';
                } else {
                    const error = await response.json();
                    alert('Failed to delete customer: ' + error.message);
                }
            } catch (error) {
                console.error('Error deleting customer: ', error);
                alert('An error occurred while deleting the customer.');
            }
        }

         // Attach click event to the delete button
         document.getElementById('delete-button').addEventListener('click', () => {
            const customerId = document.getElementById('delete-button').dataset.customerId;
            if (customerId && confirm('Are you sure you want to delete this record?')) {
                deleteCustomer(customerId);
            }
        });

        // Fetch all customers on page load
        fetchAllCustomers();
    </script>




    <!-- =========================================================================== -->

    <!-- This is the previous button oriented list -->

    <!-- <script>
        function handleClick(value) {
            fetchCustomerData(value);
        }
    </script>
    
    <div class="container">
        <h1>SQL Call testing points</h1>
        <button onclick="handleClick('0')">Button 1</button>
        <button onclick="handleClick('1')">Button 2</button>
        <button onclick="handleClick('2')">Button 3</button>
        <button onclick="handleClick('3')">Button 4</button>

        <br>
    </div>
    <br> -->
    

    <!-- =========================================================================== -->


    <div>
        <br>
        <a href="insert.html" style="color: white;">Go to Insert Page</a>
    </div>


    <!-- Link to the script to fetch and display data -->
    <script src="app.js"></script>

    <!-- Bootstrap JS and dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- SheetJS Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- JavaScript for Reset -->
    <script>

    // Update modal's percentage field before opening
        document.getElementById('googleButton').addEventListener('click', function () {
            const percentageField = document.getElementById('percentageField').value;
            document.getElementById('modalPercentageField').value = percentageField || 'N/A';
        });

        // Clear the table and reset the form when "Approve" is clicked
        document.getElementById('approveButton').addEventListener('click', function () {
            // Clear the table
            document.getElementById('tableHead').innerHTML = '';
            document.getElementById('tableBody').innerHTML = '';

            // Reset input fields
            document.getElementById('fileInput').value = '';
            document.getElementById('totalField').value = '';
            document.getElementById('percentageField').value = '';


            // Show the toast
            const toast = new bootstrap.Toast(document.getElementById('successToast'));
            toast.show();

        });

        // Additional JavaScript for table parsing remains unchanged
    </script>

    <!-- JavaScript for Parsing XLSX -->
    <script>
        
        // JavaScript remains unchanged from the previous implementation
        document.getElementById('parseButton').addEventListener('click', function () {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            if (!file) {
                alert('Please select an XLSX file first!');
                return;
            }

            const reader = new FileReader();
            reader.onload = function (event) {
                const data = new Uint8Array(event.target.result);
                const workbook = XLSX.read(data, { type: 'array' });

                // Get the first sheet name and data
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                const tableHead = document.getElementById('tableHead');
                const tableBody = document.getElementById('tableBody');
                const formatter = new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD',
                });

                tableHead.innerHTML = '';
                tableBody.innerHTML = '';

                jsonData.forEach((row, index) => {
                    const tr = document.createElement('tr');
                    let containsScheduled = false; // Track if row contains "Scheduled"


                    row.forEach((cell, cellIndex) => {
                        const cellElement = document.createElement(index === 0 ? 'th' : 'td');

                        // Format column C as date
                        if (index > 0 && cellIndex === 2) {
                            const date = new Date(cell);
                            if (!isNaN(date)) {
                                cellElement.textContent = date.toLocaleDateString('en-US', {
                                    year: 'numeric',
                                    month: 'short',
                                    day: 'numeric',
                                });
                            } else {
                                cellElement.textContent = cell || ''; // Handle invalid dates
                            }

                            
                        }
                        // Format column D as currency
                        else if (index > 0 && cellIndex === 3 && !isNaN(cell)) {
                            cellElement.textContent = formatter.format(cell);
                        }
                        // Format column F as "Open Job" hyperlink
                        else if (index > 0 && cellIndex === 5) {
                            if (isValidURL(cell)) {
                                const link = document.createElement('a');
                                link.href = cell;
                                link.textContent = 'Open Job';
                                link.target = '_blank'; // Open in new tab
                                cellElement.appendChild(link);
                            } else {
                                cellElement.textContent = cell || ''; // Handle invalid URLs or empty cells
                            }
                        }
                        // Highlight column E if it contains "Scheduled"
                        else if (index > 0 && cellIndex === 4 && typeof cell === 'string' && cell.includes('Scheduled')) {
                            cellElement.textContent = cell;
                            containsScheduled = true;
                            cellElement.classList.add('strobe-glow'); // Add strobe and glow effect

                            cellElement.classList.add('highlight-pink');
                        } else {
                            cellElement.textContent = cell || ''; // Handle other cells
                        }

                        tr.appendChild(cellElement);
                    });

                    if (index === 0) {
                        tableHead.appendChild(tr); // Add to the header


                    } else {

                         // Add class to non-selectable rows
                         if (containsScheduled) {
                            tr.classList.add('non-selectable');
                            tr.addEventListener('click', function () {
                                tr.classList.add('flash');
                                setTimeout(() => tr.classList.remove('flash'), 500); // Remove flash after animation
                            });
                        }
                        // Apply slide-down animation
                        setTimeout(() => {
                            tr.classList.add('slide-down');
                            tableBody.appendChild(tr);
                        }, index * 100); // Delay for each row

                        // Add click event listener for row selection
                        tr.addEventListener('click', function () {
                            tr.classList.toggle('table-active');
                            updateTotals(); // Update totals whenever a row is clicked
                        });
                    }
                });

                // Clear previous totals
                updateTotals();
            };

            reader.readAsArrayBuffer(file);
        });

        function isValidURL(string) {
            try {
                new URL(string);
                return true;
            } catch (_) {
                return false;
            }
        }

        function updateTotals() {
            const selectedRows = document.querySelectorAll('#tableBody tr.table-active');
            const totalField = document.getElementById('totalField');
            const percentageField = document.getElementById('percentageField');
            const formatter = new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
            });

            let columnDTotal = 0;

            selectedRows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 4 && cells[3].textContent) {
                    const value = parseFloat(cells[3].textContent.replace(/[^0-9.-]+/g, '')); // Remove currency symbols
                    if (!isNaN(value)) columnDTotal += value;
                }
            });

            // Update total and 93% fields
            totalField.value = formatter.format(columnDTotal);
            percentageField.value = formatter.format(columnDTotal * 0.93);
        }

        document.getElementById('selectAllButton').addEventListener('click', function () {
            const rows = document.querySelectorAll('#tableBody tr');
            rows.forEach(row => {
                row.classList.add('table-active');
            });

            updateTotals(); // Update totals when all rows are selected
        });

        document.getElementById('selectNoneButton').addEventListener('click', function () {
            const rows = document.querySelectorAll('#tableBody tr');
            rows.forEach(row => {
                row.classList.remove('table-active');
            });

            updateTotals(); // Update totals when no rows are selected
        });

    </script>

</body>
</html>



